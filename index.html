<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioLog - Journal Sant√© & Analyse IA</title>
    <style>
        :root {
            --primary: #4a90e2;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #1a1a1a;
            --text-light: #707070;
            --accent: #27ae60;
            --symptom: #9b59b6;
            --danger: #ff4757;
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
        }

        header {
            background: var(--card-bg);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .container {
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-light);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 600;
            border: none;
            background: none;
            cursor: pointer;
        }

        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: #f9f9f9;
            font-size: 1rem;
            margin-bottom: 8px;
            font-family: inherit;
        }

        .suggestions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .suggestion-chip {
            background: #eef5ff;
            color: var(--primary);
            border: 1px solid #d0e3ff;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }

        .symptoms-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .symptom-checkbox { display: none; }
        .symptom-label {
            display: block;
            padding: 12px 10px;
            background: #f0f0f0;
            border-radius: 12px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            border: 2px solid transparent;
        }

        .symptom-checkbox:checked + .symptom-label {
            background: #f3ebf7;
            border-color: var(--symptom);
            color: var(--symptom);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius);
            border: none;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-ai { background: linear-gradient(135deg, #6e8efb, #a777e3); color: white; }
        .btn-danger { background: #fff1f2; color: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid #e0e0e0; color: var(--text-light); }

        .log-entry {
            background: white;
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 12px;
            border-left: 5px solid var(--primary);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }

        .log-date { font-weight: 700; }
        .log-type { background: #eef5ff; color: var(--primary); padding: 2px 8px; border-radius: 6px; }

        .log-label { font-weight: 700; color: var(--text-light); font-size: 0.75rem; display: block; }

        .badge {
            background: #f3ebf7;
            color: var(--symptom);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 5px;
            display: inline-block;
            margin-top: 5px;
        }

        .log-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            border-top: 1px solid #f0f0f0;
            padding-top: 10px;
        }

        .btn-sm { padding: 8px 12px; font-size: 0.8rem; border-radius: 8px; flex: 1; margin: 0; }

        #message-box {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            padding: 15px;
            border-radius: 12px;
            background: #333;
            color: white;
            text-align: center;
            display: none;
            z-index: 2000;
        }

        /* AI Analysis Modal */
        #ai-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: none;
            padding: 20px;
            overflow-y: auto;
        }

        .ai-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            margin: 40px auto;
        }

        .ai-result {
            line-height: 1.6;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }

        /* Confirm Modal personnalis√© */
        #confirm-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .confirm-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .confirm-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div id="message-box"></div>

<!-- Modal de Confirmation Personnalis√© -->
<div id="confirm-modal">
    <div class="confirm-card">
        <h3 id="confirm-msg" style="margin-top:0;">√ätes-vous s√ªr ?</h3>
        <div class="confirm-actions">
            <button class="btn btn-outline" onclick="closeConfirm()" style="margin:0;">Annuler</button>
            <button class="btn btn-danger" onclick="executeConfirm()" style="margin:0;">Confirmer</button>
        </div>
    </div>
</div>

<!-- Modal IA -->
<div id="ai-modal" onclick="this.style.display='none'">
    <div class="ai-card" onclick="event.stopPropagation()">
        <h2 style="margin-top:0; color:var(--symptom)">Analyse IA de Sant√©</h2>
        <div id="ai-content" class="ai-result">Chargement de l'analyse...</div>
        <button class="btn btn-outline" style="margin-top:20px" onclick="document.getElementById('ai-modal').style.display='none'">Fermer</button>
    </div>
</div>

<header>
    <h1>BIOLOG JOURNAL</h1>
</header>

<div class="container">
    <!-- ONGLET SAISIE -->
    <div id="tab-add" class="tab-content active">
        <form id="logForm">
            <input type="hidden" id="editId" value="">
            <div class="card">
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label for="date">Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div style="flex: 1;">
                        <label for="time">Heure</label>
                        <input type="time" id="time" required>
                    </div>
                </div>
                
                <label for="type">Type d'entr√©e</label>
                <select id="type">
                    <option value="Petit-d√©jeuner">Petit-d√©jeuner</option>
                    <option value="D√©jeuner">D√©jeuner</option>
                    <option value="D√Æner">D√Æner</option>
                    <option value="Collation">Collation</option>
                    <option value="Hors Repas">Hors Repas (Sympt√¥mes seuls)</option>
                </select>

                <label for="foods">Aliments consomm√©s</label>
                <textarea id="foods" placeholder="Ex: P√¢tes carbonara, salade..." rows="3"></textarea>
                <div id="food-suggestions" class="suggestions-container"></div>

                <label for="drinks">Boissons</label>
                <textarea id="drinks" placeholder="Ex: Eau gazeuse, caf√©..." rows="2"></textarea>
            </div>

            <div class="card">
                <label>Sympt√¥mes</label>
                <div class="symptoms-grid">
                    <div>
                        <input type="checkbox" id="s_ventre" class="symptom-checkbox" value="Mal de ventre">
                        <label for="s_ventre" class="symptom-label">Mal de ventre</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s_ballon" class="symptom-checkbox" value="Ballonnement">
                        <label for="s_ballon" class="symptom-label">Ballonnement</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s_diarr" class="symptom-checkbox" value="Diarrh√©e">
                        <label for="s_diarr" class="symptom-label">Diarrh√©e</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s_const" class="symptom-checkbox" value="Constipation">
                        <label for="s_const" class="symptom-label">Constipation</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s_nausee" class="symptom-checkbox" value="Naus√©es">
                        <label for="s_nausee" class="symptom-label">Naus√©es</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s_fatigue" class="symptom-checkbox" value="Fatigue">
                        <label for="s_fatigue" class="symptom-label">Fatigue</label>
                    </div>
                </div>
                <input type="text" id="other_symptoms" placeholder="Autre sympt√¥me ou note...">
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary">Enregistrer l'entr√©e</button>
            <div id="editButtons" style="display:none;">
                <button type="button" id="updateBtn" class="btn btn-accent" onclick="saveLog()">Mettre √† jour</button>
                <button type="button" id="cancelBtn" class="btn btn-outline" onclick="resetForm()">Annuler</button>
            </div>
        </form>
    </div>

    <!-- ONGLET JOURNAL -->
    <div id="tab-list" class="tab-content">
        <button onclick="analyzeWithAI()" class="btn btn-ai">‚ú® Analyser mes coupables (IA)</button>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button onclick="exportCSV()" class="btn btn-outline btn-sm">Export CSV</button>
            <button onclick="clearAll()" class="btn btn-danger btn-sm">Vider le journal</button>
        </div>
        <div id="logsContainer"></div>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('add')">
        <span class="nav-icon">üìù</span>
        <span>Saisir</span>
    </button>
    <button class="nav-item" onclick="switchTab('list')">
        <span class="nav-icon">üìñ</span>
        <span>Journal</span>
    </button>
</nav>

<script>
    const apiKey = ""; // G√©r√© par l'environnement
    let logs = JSON.parse(localStorage.getItem('healthLogs')) || [];

    // --- INITIALISATION ---
    window.onload = () => {
        setDefaultDate();
        renderLogs();
        updateSuggestions();
    };

    function setDefaultDate() {
        const now = new Date();
        document.getElementById('date').value = now.toISOString().split('T')[0];
        document.getElementById('time').value = now.toTimeString().slice(0,5);
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        const index = tab === 'add' ? 0 : 1;
        document.querySelectorAll('.nav-item')[index].classList.add('active');
        if(tab === 'list') renderLogs();
    }

    // --- GESTION DES DONN√âES ---
    const logForm = document.getElementById('logForm');
    logForm.onsubmit = (e) => {
        e.preventDefault();
        saveLog();
    };

    function saveLog() {
        const id = document.getElementById('editId').value || Date.now().toString();
        const entry = {
            id: id,
            date: document.getElementById('date').value,
            time: document.getElementById('time').value,
            type: document.getElementById('type').value,
            foods: document.getElementById('foods').value.trim(),
            drinks: document.getElementById('drinks').value.trim(),
            symptoms: []
        };

        document.querySelectorAll('.symptom-checkbox:checked').forEach(cb => entry.symptoms.push(cb.value));
        const other = document.getElementById('other_symptoms').value.trim();
        if(other) entry.symptoms.push(other);

        if(!entry.foods && entry.symptoms.length === 0) {
            showMessage("Veuillez remplir au moins un aliment ou un sympt√¥me", "error");
            return;
        }

        const existingIdx = logs.findIndex(l => l.id === id);
        if(existingIdx > -1) logs[existingIdx] = entry;
        else logs.push(entry);

        logs.sort((a,b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
        localStorage.setItem('healthLogs', JSON.stringify(logs));
        
        showMessage("Entr√©e enregistr√©e !");
        resetForm();
        switchTab('list');
    }

    function resetForm() {
        logForm.reset();
        document.getElementById('editId').value = "";
        document.querySelectorAll('.symptom-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('submitBtn').style.display = 'block';
        document.getElementById('editButtons').style.display = 'none';
        setDefaultDate();
        updateSuggestions();
    }

    // --- RENDU ET ACTIONS ROBUSTES ---
    function renderLogs() {
        const container = document.getElementById('logsContainer');
        container.innerHTML = "";

        if(logs.length === 0) {
            container.innerHTML = '<div class="card" style="text-align:center;color:gray">Aucune entr√©e pour le moment</div>';
            return;
        }

        logs.forEach(log => {
            const div = document.createElement('div');
            div.className = "log-entry";
            div.innerHTML = `
                <div class="log-header">
                    <span class="log-date">${log.date} @ ${log.time}</span>
                    <span class="log-type">${log.type}</span>
                </div>
                <div style="margin-bottom:8px">
                    ${log.foods ? `<div><span class="log-label">ALIMENTS</span>${log.foods}</div>` : ''}
                    ${log.drinks ? `<div><span class="log-label">BOISSONS</span>${log.drinks}</div>` : ''}
                    ${log.symptoms.length > 0 ? `
                        <div style="margin-top:5px">
                            ${log.symptoms.map(s => `<span class="badge">${s}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
                <div class="log-actions">
                    <button class="btn btn-outline btn-sm" onclick="editEntry('${log.id}')">Modifier</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteEntry('${log.id}')">Supprimer</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    window.deleteEntry = function(id) {
        showConfirm("Supprimer cette entr√©e ?", () => {
            logs = logs.filter(l => l.id !== id);
            localStorage.setItem('healthLogs', JSON.stringify(logs));
            renderLogs();
            showMessage("Entr√©e supprim√©e", "error");
        });
    };

    window.editEntry = function(id) {
        const log = logs.find(l => l.id === id);
        if(log) {
            switchTab('add');
            document.getElementById('editId').value = log.id;
            document.getElementById('date').value = log.date;
            document.getElementById('time').value = log.time;
            document.getElementById('type').value = log.type;
            document.getElementById('foods').value = log.foods;
            document.getElementById('drinks').value = log.drinks;
            
            document.querySelectorAll('.symptom-checkbox').forEach(cb => {
                cb.checked = log.symptoms.includes(cb.value);
            });
            
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('editButtons').style.display = 'block';
        }
    };

    // --- ANALYSE IA (GEMINI) RE-OPTIMIS√âE ---
    async function analyzeWithAI() {
        if (logs.length < 3) {
            showMessage("Ajoutez au moins 3 entr√©es.", "error");
            return;
        }

        const modal = document.getElementById('ai-modal');
        const content = document.getElementById('ai-content');
        modal.style.display = 'block';
        content.innerHTML = "L'IA analyse vos tendances<span class='loading-dots'></span>";

        // Version ultra simplifi√©e pour √©viter les blocages de s√©curit√© m√©dicaux
        const dataText = logs.slice(0, 10).map(l => {
            return `Repas: ${l.foods || 'N/A'}. Resultat: ${l.symptoms.join(', ') || 'OK'}`;
        }).join('\n');

        const promptText = `Agis comme un analyste de donn√©es logique. Voici une liste d'observations. Identifie s'il y a une corr√©lation r√©p√©t√©e entre un mot dans 'Repas' et un mot dans 'Resultat'. R√©ponds en 2 phrases simples sans utiliser de termes m√©dicaux complexes. Ne pas utiliser d'ast√©risques.
        
        Observations :
        ${dataText}`;

        const fetchAI = async () => {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ 
                        parts: [{ text: promptText }] 
                    }],
                    generationConfig: {
                        temperature: 0.4,
                        maxOutputTokens: 150
                    }
                })
            });
            
            if (!response.ok) throw new Error("Status " + response.status);
            
            const data = await response.json();
            return data?.candidates?.[0]?.content?.parts?.[0]?.text;
        };

        try {
            let text = await fetchAI();
            if (!text) throw new Error("Vide");
            
            // Nettoyage strict pour affichage
            text = text.replace(/[*#\-_]/g, '').trim();
            content.innerHTML = text;
            
        } catch (error) {
            console.error(error);
            // Synth√®se manuelle si l'IA refuse encore
            let fallback = "L'IA est trop prudente pour r√©pondre en direct. Voici vos observations r√©centes :<br><br>";
            const counts = {};
            logs.flatMap(l => l.symptoms).forEach(s => counts[s] = (counts[s] || 0) + 1);
            
            const topSymptoms = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 2);
            
            if (topSymptoms.length > 0) {
                fallback += `Sympt√¥mes fr√©quents : ${topSymptoms.map(s => s[0]).join(' et ')}.<br><br>`;
                fallback += "V√©rifiez vos repas pr√©c√©dents ces sympt√¥mes pour trouver un point commun.";
            } else {
                fallback += "Aucun sympt√¥me r√©current d√©tect√© pour le moment.";
            }
            
            content.innerHTML = fallback;
        }
    }

    // --- UTILITAIRES ---
    function updateSuggestions() {
        const container = document.getElementById('food-suggestions');
        container.innerHTML = "";
        const allFoods = logs.flatMap(l => l.foods.split(',')).map(f => f.trim()).filter(f => f.length > 2);
        const uniqueFoods = [...new Set(allFoods)].slice(0, 5);
        
        uniqueFoods.forEach(food => {
            const chip = document.createElement('div');
            chip.className = 'suggestion-chip';
            chip.textContent = "+ " + food;
            chip.onclick = () => {
                const input = document.getElementById('foods');
                input.value = input.value ? input.value + ", " + food : food;
            };
            container.appendChild(chip);
        });
    }

    function showMessage(text, type = "success") {
        const box = document.getElementById('message-box');
        box.textContent = text;
        box.style.background = type === "error" ? "var(--danger)" : "var(--accent)";
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 3000);
    }

    function exportCSV() {
        let csv = "Date;Heure;Type;Aliments;Boissons;Symptomes\n";
        logs.forEach(l => {
            csv += `${l.date};${l.time};${l.type};"${l.foods}";"${l.drinks}";"${l.symptoms.join(',')}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "journal_biolog.csv";
        link.click();
    }

    // --- GESTION DES CONFIRMATIONS ---
    let confirmAction = null;
    
    function showConfirm(msg, callback) {
        document.getElementById('confirm-msg').textContent = msg;
        confirmAction = callback;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    window.closeConfirm = function() {
        document.getElementById('confirm-modal').style.display = 'none';
        confirmAction = null;
    }

    window.executeConfirm = function() {
        if(confirmAction) confirmAction();
        closeConfirm();
    }

    window.clearAll = function() {
        showConfirm("Voulez-vous vraiment effacer tout votre historique ?", () => {
            logs = [];
            localStorage.removeItem('healthLogs');
            renderLogs();
            showMessage("Journal vid√©", "error");
        });
    }
</script>

</body>
</html>
